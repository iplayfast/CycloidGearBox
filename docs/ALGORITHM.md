# Cycloidal Gearbox Algorithm Documentation

## Overview

This document explains the mathematical algorithms used to generate a cycloidal gearbox in the CycloidGearBox FreeCAD workbench.

## What is a Cycloidal Drive?

A cycloidal drive (also known as a cycloidal speed reducer) is a mechanism for reducing the speed of an input shaft by a certain ratio. It uses cycloidal motion to achieve high reduction ratios in a compact form factor with high efficiency and durability.

### Key Advantages:
- High reduction ratios (10:1 to 100:1+)
- High efficiency (>90%)
- Compact size
- High torque capacity
- Zero backlash (when properly designed)
- Long service life

## Mathematical Foundation

### 1. Hypocycloid Generation

The cycloidal disk profile is based on a **hypocycloid** - a curve generated by tracing a point on a small circle as it rolls inside a larger circle.

#### Parameters:
- **R**: Radius of the fixed circle (roller circle radius)
- **r**: Radius of the rolling circle
- **e**: Eccentricity (distance from rolling circle center to tracing point)
- **N**: Number of teeth (or rollers)

#### Parametric Equations:

For a point on the cycloidal disk at angle θ:

```
x(θ) = (N·p)·cos(θ) + e·cos((N+1)·θ) - (d_r/2)·cos(α + θ)
y(θ) = (N·p)·sin(θ) + e·sin((N+1)·θ) - (d_r/2)·sin(α + θ)
```

Where:
- `p = R / N` (pitch parameter)
- `d_r` = roller diameter
- `α` = pressure angle offset (calculated by `calcyp()`)

#### Pressure Angle Offset (α):

The pressure angle offset compensates for the finite roller diameter:

```
α = atan(sin(N·θ) / (cos(N·θ) + (N·p)/(e·(N+1))))
```

This is implemented in the `calcyp()` function.

### 2. Epitrochoid Radii Calculation

The relationship between the fixed circle (R) and rolling circle (r) is:

```
r₁ + r₂ = R
r₁/r₂ = N - 1
```

Solving these equations:
```
r₁ = (N-1) · R/N
r₂ = R/N
```

This is implemented in `calculate_radii()`.

### 3. Pressure Angle Calculation

The pressure angle determines where the cycloidal disk contacts the rollers. Too high a pressure angle causes binding.

```
pressure_angle = asin((r₃·cos(θ) - r_g) / (p_p + d_r/2)) · 180/π
```

Where:
- `r₃ = p · N` (pitch circle radius)
- `r_g = r₃/√2` (geometric parameter)
- `p_p = r_g·√(2 + 1 - 2√2·cos(θ)) - d_r/2`

Implemented in `calculate_pressure_angle()`.

### 4. Pressure Angle Limit Circles

The workbench calculates minimum and maximum radii based on the pressure angle limit:

1. Iterate through angles 0° to 180°
2. Find first angle where pressure angle < limit (min angle)
3. Find first angle where pressure angle < -limit (max angle)
4. Calculate corresponding radii using `calculate_pressure_limit()`

This defines the valid region where the cycloidal disk can mesh properly with the rollers.

## Gear Ratio

The gear ratio of a cycloidal drive is:

```
ratio = 1 / N
```

Where N is the number of teeth on the cycloidal disk.

More precisely, for a cycloidal disk with N lobes and N+1 rollers:

```
ratio = -N / ((N+1) - N) = -N
```

The negative sign indicates the output rotates opposite to the input.

**Example:** With N=11 teeth, the ratio is 1:11 (input rotates 11 times for 1 output rotation).

## Component Generation

The workbench generates 7 main components:

### 1. Pin Disk
- Contains N+1 fixed rollers
- Rollers are arranged in a circle
- Provides the fixed reference for the cycloidal disk

### 2. Driver Disk
- Connects to the cycloidal disks
- Has holes for the output shaft pins
- Transfers motion from cycloidal disks to output

### 3. Input Shaft
- Has eccentric pins/lobes
- Rotates the cycloidal disks with eccentricity e
- Contains keyway for motor coupling

### 4 & 5. Cycloidal Disks (2 disks)
- Profile generated using hypocycloid equations
- Two disks offset 180° balance forces
- Central holes with eccentricity e
- Driver pin holes

### 6. Eccentric Key
- Fits into cycloidal disk holes
- Maintains proper eccentric relationship
- Transfers rotation from input shaft

### 7. Output Shaft
- Receives motion from driver disk
- Has driver pin holes matching driver disk
- Contains output keyway

## Parameter Constraints

### Valid Ranges:

| Parameter | Minimum | Maximum | Notes |
|-----------|---------|---------|-------|
| tooth_count (N) | 3 | 50 | Typically 10-20 for good performance |
| eccentricity (e) | 0.1 mm | roller_radius | e ≤ d_r/2 recommended |
| roller_diameter | 0.1 mm | R·sin(π/N) | Must fit in roller circle |
| pressure_angle_limit | 10° | 85° | 30-50° typical for manufacturability |
| shaft_diameter | 0.1 mm | - | Must support torque loads |

### Interdependencies:

1. **Diameter > roller_circle_diameter**
   - Outer housing must contain roller circle

2. **roller_circle_diameter > roller_diameter**
   - Rollers must fit inside their mounting circle

3. **driver_circle_diameter > shaft_diameter**
   - Driver mechanism must clear shaft

4. **eccentricity ≤ roller_diameter/2**
   - Prevents undercutting of disk profile

## Algorithm Implementation Flow

```
1. Validate input parameters
   ↓
2. Calculate pressure angle limits
   ↓
3. Calculate min/max radii
   ↓
4. Generate cycloidal disk profile array
   ↓
5. Create FreeCAD sketches with B-splines
   ↓
6. Generate 3D parts using Pad/Pocket
   ↓
7. Apply polar patterns for repeated features
   ↓
8. Assemble all components
```

## Key Functions Reference

### Core Math Functions

- **`calc_x(p, roller_diameter, eccentricity, tooth_count, angle)`**
  - Calculates X coordinate of cycloidal disk point
  - Returns: float (X coordinate in mm)

- **`calc_y(p, roller_diameter, eccentricity, tooth_count, angle)`**
  - Calculates Y coordinate of cycloidal disk point
  - Returns: float (Y coordinate in mm)

- **`calcyp(p, a, e, n)`**
  - Calculates pressure angle offset
  - Returns: float (angle in radians)

- **`calculate_pressure_angle(p, roller_diameter, tooth_count, angle)`**
  - Calculates pressure angle at given position
  - Returns: float (angle in degrees)

### Validation Functions

- **`validate_parameters(parameters)`**
  - Validates all gearbox parameters
  - Raises: ParameterValidationError if invalid

- **`calculate_min_max_radii(parameters)`**
  - Calculates valid pressure angle limit circles
  - Returns: (min_radius, max_radius) tuple

### Generation Functions

- **`generate_cycloidal_disk_array(parameters)`**
  - Generates array of points defining cycloidal disk profile
  - Returns: List[Vector] of profile points

- **`generate_parts(doc, parameters)`**
  - Main function - generates all 7 components
  - Thread-safe with automatic locking
  - Validates parameters before generation

## Error Handling

The implementation includes comprehensive error handling:

1. **Parameter Validation Errors**
   - Invalid tooth count, dimensions, etc.
   - User-friendly error messages

2. **Math Domain Errors**
   - Division by zero protection
   - asin/acos domain clamping [-1, 1]
   - Logged warnings for clamped values

3. **Thread Safety**
   - Threading.Lock prevents concurrent generation
   - Non-blocking lock acquisition

## Performance Considerations

- **Line Segment Count**: Default 42 (tooth_count²)
  - Higher = smoother profile, slower generation
  - Lower = faster but faceted profile

- **Caching**: Min/max radii calculated once and stored in parameters

- **Random Seed**: Fixed (555) for consistent colors across regenerations

## References

1. [Wikipedia: Cycloidal Drive](https://en.wikipedia.org/wiki/Cycloidal_drive)
2. [Formulas for calculating pressure angle and limit circles](http://imtuoradea.ro/auo.fmte/files-2.07/MECATRONICA_files/Anamaria_Dascalescu_1.pdf)
3. [Hypocycloid formulas](http://gears.ru/transmis/zaprogramata/2.0.139.pdf)

## Troubleshooting

### Common Issues:

**Problem**: "tooth_count must be >= 3"
- **Solution**: Increase tooth_count to at least 3

**Problem**: "Diameter must be > roller_circle_diameter"
- **Solution**: Increase Diameter or decrease roller_circle_diameter

**Problem**: Parts overlap or interfere
- **Solution**: Check driver_circle_diameter < min_radius * 2

**Problem**: Profile has sharp cusps
- **Solution**: Increase line_segment_count or adjust pressure_angle_offset

**Problem**: "Division by zero in calcyp"
- **Solution**: This indicates incompatible parameters. Try different eccentricity or roller diameter.

## Future Enhancements

Potential areas for improvement:

1. GUI parameter validation with live preview
2. Strength/stress analysis integration
3. Custom tooth profiles (not just hypocycloid)
4. Assembly constraints and motion simulation
5. Manufacturing tolerance analysis
6. Automated optimization for specific ratios
